const SHEET_ID = '1_n6qYGMfMG2xNVkCzbr71Jjl4NfTSyV0aaas_tXgGIg';
const SHEET_NAME = 'Comments';

function doGet(e) {
  const output = ContentService.createTextOutput(JSON.stringify(getComments()));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

function doPost(e) {
  try {
    const params = JSON.parse(e.postData.contents);
    if(params.action === 'addComment') {
      addComment(params.comment);
      const output = ContentService.createTextOutput(JSON.stringify({status: 'success'}));
      output.setMimeType(ContentService.MimeType.JSON);
      return output;
    } else if(params.action === 'addReply') {
      addReply(params.commentId, params.reply);
      const output = ContentService.createTextOutput(JSON.stringify({status: 'success'}));
      output.setMimeType(ContentService.MimeType.JSON);
      return output;
    }
  } catch(err) {
    const output = ContentService.createTextOutput(JSON.stringify({status: 'error', message: err.message}));
    output.setMimeType(ContentService.MimeType.JSON);
    return output;
  }
  const output = ContentService.createTextOutput(JSON.stringify({status: 'error', message: 'Invalid action'}));
  output.setMimeType(ContentService.MimeType.JSON);
  return output;
}

function doOptions(e) {
  return ContentService.createTextOutput('').setMimeType(ContentService.MimeType.TEXT);
}

function getComments() {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  return data.map(row => {
    let obj = {};
    headers.forEach((h, i) => {
      if(h === 'replies') {
        try {
          obj[h] = JSON.parse(row[i]) || [];
        } catch {
          obj[h] = [];
        }
      } else if(h === 'ts') {
        obj[h] = Number(row[i]) || Date.now();
      } else {
        obj[h] = row[i];
      }
    });
    return obj;
  });
}

function addComment(comment) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  sheet.insertRowBefore(2);
  sheet.getRange(2, 1, 1, 5).setValues([[ 
    comment.id, 
    comment.name, 
    comment.text, 
    comment.ts, 
    JSON.stringify(comment.replies || []) 
  ]]);
}

function addReply(commentId, reply) {
  const ss = SpreadsheetApp.openById(SHEET_ID);
  const sheet = ss.getSheetByName(SHEET_NAME);
  const data = sheet.getDataRange().getValues();
  const headers = data.shift();
  const idIndex = headers.indexOf('id');
  const repliesIndex = headers.indexOf('replies');

  for(let i = 0; i < data.length; i++) {
    if(data[i][idIndex] === commentId) {
      let replies = [];
      try {
        replies = JSON.parse(data[i][repliesIndex]) || [];
      } catch {
        replies = [];
      }
      replies.push(reply);
      sheet.getRange(i + 2, repliesIndex + 1).setValue(JSON.stringify(replies));
      break;
    }
  }
}
