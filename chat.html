<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Comment System</title>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin: auto; padding: 20px; }
    #comments-container { border: 1px solid #ccc; padding: 10px; margin-top: 20px; }
    .comment, .reply { border-bottom: 1px solid #eee; padding: 10px; margin: 10px; }
    .reply { margin-left: 40px; }
    form { display: flex; flex-direction: column; }
    input, textarea { margin-bottom: 10px; padding: 8px; }
    button { padding: 10px; cursor: pointer; }
  </style>
</head>
<body>

  <h1>Comment System</h1>

  <form id="comment-form">
    <label for="comment-text">Add a New Comment:</label>
    <textarea id="comment-text" required></textarea>
    <button type="submit">Post Comment</button>
  </form>

  <div id="comments-container">
    <h2>Existing Comments</h2>
    <p>Loading comments...</p>
  </div>

  <script>
    // IMPORTANT: Replace this with your actual deployed Apps Script URL
    const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwNJEQIYtyJJdLdRYnfjVP4NvJK2DNCvZGr7H6geEjfg48DrinYY44erPxzlEImVkvD/exec';

    // A helper function to generate a unique ID for each comment
    function generateId() {
      return 'id_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    // Function to fetch and display comments
    async function fetchComments() {
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'GET',
          mode: 'cors'
        });
        const comments = await response.json();
        
        const commentsContainer = document.getElementById('comments-container');
        commentsContainer.innerHTML = '<h2>Existing Comments</h2>'; // Clear existing comments

        if (comments.length === 0) {
          commentsContainer.innerHTML += '<p>No comments yet. Be the first to post!</p>';
        } else {
          comments.forEach(comment => {
            const commentElement = document.createElement('div');
            commentElement.className = 'comment';
            commentElement.innerHTML = `
              <strong>Comment ID: ${comment.id}</strong><br>
              <strong>${comment.name || 'Anonymous'}</strong>: ${comment.text}
              <form class="reply-form" data-comment-id="${comment.id}">
                <textarea class="reply-text" placeholder="Write a reply..." required></textarea>
                <button type="submit">Reply</button>
              </form>
            `;
            commentsContainer.appendChild(commentElement);

            // Display replies
            if (comment.replies && comment.replies.length > 0) {
              comment.replies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.className = 'reply';
                replyElement.innerHTML = `
                  <strong>${reply.name || 'Anonymous'}</strong>: ${reply.text}
                `;
                commentElement.appendChild(replyElement);
              });
            }
          });
        }
      } catch (error) {
        console.error('Error fetching comments:', error);
        document.getElementById('comments-container').innerHTML = '<p style="color:red;">Error loading comments. Please check the console.</p>';
      }
    }

    // Event listener for the new comment form
    document.getElementById('comment-form').addEventListener('submit', async (event) => {
      event.preventDefault();
      const commentText = document.getElementById('comment-text').value;

      const data = {
        action: 'addComment',
        comment: {
          id: generateId(),
          name: 'Client User',
          text: commentText,
          ts: Date.now()
        }
      };
      
      await sendData(data);
      document.getElementById('comment-text').value = '';
      fetchComments(); // Refresh comments after posting
    });
    
    // Event listener for all reply forms (using event delegation)
    document.getElementById('comments-container').addEventListener('submit', async (event) => {
      event.preventDefault();
      const form = event.target;
      if (form.classList.contains('reply-form')) {
        const commentId = form.dataset.commentId;
        const replyText = form.querySelector('.reply-text').value;

        const data = {
          action: 'addReply',
          commentId: commentId,
          reply: {
            name: 'Replier',
            text: replyText,
            ts: Date.now()
          }
        };

        await sendData(data);
        form.querySelector('.reply-text').value = '';
        fetchComments(); // Refresh comments after posting
      }
    });

    // Function to send data via a POST request
    async function sendData(data) {
      try {
        const response = await fetch(WEB_APP_URL, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        const result = await response.json();
        console.log(result);
        if (result.status === 'error') {
          console.error('Server error:', result.message);
        }
      } catch (error) {
        console.error('Error sending data:', error);
      }
    }

    // Initial fetch of comments when the page loads
    fetchComments();
  </script>

</body>
</html>

