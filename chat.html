<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Comment System with PapaParse & Google Forms</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 700px; margin: auto; padding: 20px; }
    #comments { margin-top: 20px; }
    .comment { border-bottom: 1px solid #ccc; padding: 10px 0; }
    .comment strong { display: block; }
    form { margin-top: 20px; }
    textarea, input { width: 100%; padding: 8px; margin-bottom: 10px; }
    button { padding: 10px 20px; cursor: pointer; }
  </style>
</head>
<body>

  <h1>Comments</h1>

  <div id="comments">Loading comments...</div>

  <h2>Add a Comment</h2>
  <form id="commentForm">
    <input type="text" id="name" placeholder="Your Name" required />
    <textarea id="comment" rows="4" placeholder="Your Comment" required></textarea>
    <button type="submit">Submit</button>
  </form>

  <script>
    // Your published CSV URL from Google Sheets
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTo15M7UxDrr1tLffoEjYm63kouPlN5q9QdbfFHLmD7dbCYQVNFCI_btc4DtUbmovUUFQX223b0kYUU/pub?output=csv';

    // Your Google Form POST URL
    const GOOGLE_FORM_ACTION = 'https://docs.google.com/forms/u/0/d/e/1FAIpQLSd1jVyJslDvxeJ1tzSroNRkguJo_TqMclq9gS-VitXreRbLew/formResponse';

    // Entry IDs for your form fields â€” replace these with your actual entry IDs from Google Form
    const ENTRY_NAME = 'entry.1705102253';  // replace with your Name field entry ID
    const ENTRY_COMMENT = 'entry.2053950670';  // replace with your Comment field entry ID

    const commentsContainer = document.getElementById('comments');

    function renderComments(data) {
      if (!data || data.length === 0) {
        commentsContainer.innerHTML = '<p>No comments yet.</p>';
        return;
      }
      commentsContainer.innerHTML = '';
      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'comment';
        div.innerHTML = `<strong>${item.name || 'Anonymous'}</strong><p>${item.text || item.comment || ''}</p>`;
        commentsContainer.appendChild(div);
      });
    }

    function loadComments() {
      Papa.parse(CSV_URL, {
        download: true,
        header: true,
        complete: function(results) {
          // You may need to adjust field names depending on your sheet headers
          const comments = results.data.map(row => ({
            name: row['name'] || row['Name'] || 'Anonymous',
            text: row['text'] || row['comment'] || row['Comment'] || ''
          })).filter(c => c.text.trim() !== '');
          renderComments(comments);
        },
        error: function(err) {
          commentsContainer.innerHTML = '<p style="color:red;">Failed to load comments.</p>';
          console.error('PapaParse error:', err);
        }
      });
    }

    document.getElementById('commentForm').addEventListener('submit', function(e) {
      e.preventDefault();

      const name = document.getElementById('name').value.trim();
      const comment = document.getElementById('comment').value.trim();

      if (!comment) {
        alert('Please enter a comment.');
        return;
      }

      // Prepare form data in URLSearchParams format for Google Form POST
      const formData = new URLSearchParams();
      formData.append(ENTRY_NAME, name);
      formData.append(ENTRY_COMMENT, comment);

      fetch(GOOGLE_FORM_ACTION, {
        method: 'POST',
        mode: 'no-cors',  // Google Forms does not allow CORS requests
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: formData.toString()
      }).then(() => {
        alert('Thank you for your comment!');
        document.getElementById('name').value = '';
        document.getElementById('comment').value = '';
        loadComments();
      }).catch(err => {
        alert('Failed to submit comment.');
        console.error(err);
      });
    });

    // Load comments on page load
    loadComments();
  </script>

</body>
</html>
